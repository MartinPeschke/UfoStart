<%inherit file="../../layout.html"/>
<%namespace file="hnc:forms/templates/baseform.html" name="baseform"/>
<%namespace file="../../widgets.html" name="widgets"/>

<%def name="content()">
    <div class="container">
        <div class="row">
            <div class="col col-lg-12">
                <h1 class="section-title">
                    %if resource.canEdit:
                        <span class="btn-wrapper"><a title="Edit" href="${url(resource, 'edit')}"><span class="glyphicon glyphicon-pencil"></span></a></span>
                    %endif
                    <span class="brand-primary">${product.name}</span>
                </h1>
            </div>
        </div>

        <div class="row mar-top-1">
            <div class="col col-lg-9">
                ${widgets.mainMedia("Product Presentation", product.video)}
            </div>
            <div class="col col-lg-3">
                %if product.Pictures:
                    <div class="picture-gallery-preview progress-step progress-1">
                        ${widgets.gallery("Picture Gallery", "Play Slideshow", product.Pictures)}
                    </div>
                %endif
            </div>
        </div>

        <div class="row mar-top-1">
            <div class="col col-lg-3">
                ${widgets.companyInfo(resource.company)}
                <div class="mar-top-2">
                    <div class="box-title">Customers</div>
                    ${self.customerFacepile(company.Round.Pledges)}
                </div>
            </div>
            <div class="col col-lg-6">
                <div class="main-description">
                    ${product.description | html.html,n}
                </div>
                <div class="mar-top-2">
                    <div class="box-title">Orders</div>
                    ${self.pledgeList(company.Round.Pledges)}
                </div>
            </div>
            <div class="col col-lg-3">
                ${self.offerSection(company, company.Round.Product)}
            </div>
        </div>
    </div>
</%def>

<%def name="customerFacepile(customers)">
    <div class="mar-top-half">
    %if len(customers):
        %for pledge in customers:
            <div class="picture medium">
                <img src="${pledge.picture}"/>
            </div>
        %endfor
    %else:
        <div class="empty">
            No Customers yet
        </div>
    %endif
    </div>
</%def>


<%def name="offerSection(company, product)">
    <h2>Offers</h2>
    <% form = view.schemas['ProductPledge'] %>
    ${self.displayOffer(product.offers, form)}
    %if resource.canEdit:
        <% form = view.schemas['ProductOffer'] %>
        ${self.createOfferForm(product, form, values.get(form.id), errors.get(form.id))}
    %endif
</%def>

<%def name="displayOffer(offers, form)">
    <form class="${form.grid.form_classes}" id="${form.id}" method="POST">
    ${baseform.prelims(form)}
    %for idx, offer in enumerate(offers):
        <div class="single-product-offer progress-step progress-${idx+1}">
            %if resource.canEdit:
                <a href="${url(resource, 'delete', query=[('offer', offer.name)])}" class="remove">Ã—</a>
            %endif
            <p><strong class="dark">${offer.name}</strong></p>
            <p class="text-small">${offer.description}</p>
            <div class="row">
                <div class="col col-lg-6">
                    <strong><small class="dark">Price</small></strong>
                    <div class="text-large text-light">${offer.price}</div>
                </div>
                <div class="col col-lg-6">
                    <strong><small class="dark">Stock</small></strong>
                    <div class="text-large text-light">${offer.stock}</div>
                </div>
            </div>
            <div class="mar-top-1">
                %if root.user.isAnon():
                    <a href="${root.auth_url('linkedin')}" class="btn btn-primary btn-block">Login to Pledge</a>
                %else:
                    <div class="control-group show-expanded">
                        <label class="control-label">Message</label>
                        <div class="controls">
                            <textarea class="x-high" name="ProductPledge.${html.hash(offer.name)}"></textarea>
                        </div>
                    </div>
                    <a class="btn btn-primary show-contracted" data-toggle-target=".single-product-offer" data-toggle-class="expanded">Pledge</a>
                    <button class="btn btn-primary show-expanded inline" name="ProductPledge.offer" value="${offer.name}">Pledge Now</button>
                    <a class="btn btn-default show-expanded inline" data-toggle-target=".single-product-offer" data-toggle-class="expanded">Cancel</a>
                %endif
            </div>
        </div>
    %endfor
    </form>
</%def>

<%def name="createOfferForm(product, form, values, errors)">
    <h6 class="mar-top-1">Add a new Offer</h6>
    <div class="box-dark">
        <div class="box-content clearfix">
            <form class="${form.grid.form_classes} form-compacted" id="${form.id}" method="POST">
                ${baseform.prelims(form)}
                ${form.fieldMap['name'].render(form.id, request, values, errors, view, grid = form.grid)|n}
                ${form.fieldMap['description'].render(form.id, request, values, errors, view, grid = form.grid)|n}
                <div class="row">
                    <div class="col col-lg-6">
                        ${form.fieldMap['price'].render(form.id, request, values, errors, view, grid = form.grid)|n}
                    </div>
                    <div class="col col-lg-6">
                        ${form.fieldMap['stock'].render(form.id, request, values, errors, view, grid = form.grid)|n}
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Offer</button>
            </form>
        </div>
    </div>
</%def>

<%def name="pledgeOfferForm(form, values, errors)">
    <div class="expander">
    <div class="mar-top-2">
        %if root.user.isAnon():
            <a href="${url(resource, 'pledge')}" class="btn btn-primary">Login to Pledge</a>
        %elif not resource.canEdit:
            <a class="btn btn-primary show-contracted inline" data-toggle-target=".expander" data-toggle-class="expanded">Pledge Now</a>
            <a class="btn btn-default show-expanded" data-toggle-target=".expander" data-toggle-class="expanded">Cancel</a>
        %endif
    </div>
    %if not resource.canEdit and not root.user.isAnon():
        <div class="show-expanded box-shaded box-framed">
            <div class="box-content">
                <form class="${form.grid.form_classes}" id="${form.id}" method="POST">
                    ${baseform.prelims(form)}
                    <div class="row mar-top-1">
                        <div class="col col-lg-4">
                            <div class="row">
                                <div class="col col-sm-4">
                                    <div class="picture">
                                        <img src="${root.user.picture}"/>
                                    </div>
                                </div>
                                <div class="col col-sm-8">
                                    <div class="name">${root.user.name}</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col col-lg-12">
                                    <button type="submit" class="btn btn-primary ">Submit Pledge</button>
                                </div>
                            </div>
                        </div>
                        <div class="col col-lg-8 control-group">
                            %for field in form.fields:
                                ${field.render(form.id, request, values, errors, view)|n}
                            %endfor
                        </div>
                    </div>
                </form>
            </div>
        </div>
    %endif
    </div>
</%def>

<%def name="pledgeList(pledges)">
%if len(pledges):
    %for pledge in pledges:
        <div class="row mar-top-1">
            <div class="col col-lg-4">
                <div class="row">
                    <div class="col col-sm-4">
                        <div class="picture">
                        %if pledge.is_native:
                            <a href="${request.root.profile_url(pledge.networkId)}">
                                <img src="${pledge.picture}"/>
                            </a>
                        %else:
                            <img src="${pledge.picture}"/>
                        %endif
                        </div>
                    </div>
                    <div class="col col-sm-8">
                        %if pledge.is_native:
                            <p class="name"><a href="${request.root.profile_url(pledge.networkId)}"><strong>${pledge.name}</strong></a></p>
                        %else:
                            <p class="name"><strong>${pledge.name}</strong></p>
                        %endif
                        <div class="text-small text-muted">Offer Option</div>
                        <ul class="styled">
                            <li><span class="text-small">${pledge.offer}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col col-lg-8 control-group">
                ${html.nn(pledge.comment)}
            </div>
        </div>
    %endfor
%else:
    <div class="empty">
        No Customers yet
    </div>
%endif
</%def>


<%def name="post_scripts()">
    <script>
        require(["form"], function(View){
            $("form.form-validated").each(function(idx, elem){
                new View({el: $(elem)});
            });
        });
    </script>
</%def>

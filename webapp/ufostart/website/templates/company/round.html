<%inherit file="../layout.html"/>
<%namespace file="../widgets.html" name="widgets"/>

<%def name="content()">
    <div class="container" id="project-round-need-dashboard">

        %if ctxt.round.pendingApproval:
            %if ctxt.canApprove:
                <div class="row">
                    <div class="col col-lg-12">
                        <div class="notice notice-wtf">
                            <div class="sidecrumb"></div>
                            <div class="sidecrumb"></div>
                            <div class="sidecrumb"></div>
                            <div class="content">
                                <h2>Hello ${root.user.name}</h2>
                                <h4>
                                    <a href="${root.company_url(ctxt.company.slug)}">${ctxt.company.display_name}'s</a>
                                    <a href="${root.round_url(ctxt.company.slug, 1)}">${ctxt.round.display_name} Round</a> is waiting for approval.
                                </h4>
                                <div class="mar-top-2">
                                    <a href="${url(ctxt, 'approve')}" class="btn btn-primary">Approve</a>
                                    <a href="${url(ctxt, 'reject')}" class="btn btn-default">Reject</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            %elif ctxt.canEdit:
            <div class="row">
                <div class="col col-lg-12">
                    <div class="notice notice-info">
                        <div class="sidecrumb"></div>
                        <div class="sidecrumb"></div>
                        <div class="sidecrumb"></div>
                        <div class="content">
                            Round is pending waiting for approval by a Mentor.
                        </div>
                    </div>
                </div>
            </div>
            %endif
        %endif

        <%widgets:pageHeader>
            ${ctxt.round.Template.name} <span class="sub-title">Round Dashboard</span>
        </%widgets:pageHeader>

        <div class="row mar-top-1">
            <div class="col col-lg-3 pull-right">
                ${self.sideBar(ctxt.round, ctxt.canEdit)}
            </div>
            <div class="col col-lg-9">
                ${self.upperContent(ctxt.round.published)}
                ${self.lowerContent()}
            </div>
        </div>
    </div>
</%def>

<%def name="upperContent(isPublished)">
    <div class="row">
        <div class="col col-lg-4">
            <div class="box-title">Company</div>
            ${self.companyBox(company)}
            <div class="mar-top-1">
                <div class="box-title">Product</div>
                ${self.productBox(company)}
            </div>
        </div>
        <div class="col col-lg-8">
            <div class="box-title">
                Recent Activity
            </div>
        </div>
    </div>
</%def>

<%def name="companyBox(company)">
    <div class="box-card shaded">
        ${widgets.company_logo(company)}
        <a class="entity-link  mar-top-1" href="${url(ctxt)}">${ctxt.company.name}</a>
        <div class="pitch">${html.nn(company.pitch)}</div>
    </div>
    <div class="number-widget mar-top-1">
        <h6>Startup Value</h6>
        <div class="value light">${company.displayStartupValue}</div>
    </div>
    <hr/>
    <div class="mar-top-half">
        <h6>Team members</h6>
        <div class="picture-pile">
        %for user in company.Users[:8]:
            ${widgets.userPic(user, classes='mini')|n}
        %endfor
        %if ctxt.canEdit:
            <a href="${url(ctxt.__parent__)}"><small>Invite team<br/>members</small></a>
        %endif
        </div>
    </div>
    <hr/>
    <div class="">
        <h6>Mentors</h6>
        <div class="picture-pile">
            %for user in company.mentors[:8]:
                ${widgets.userPic(user, classes='mini')|n}
            %endfor
            <span class="highlight-target" style="display:inline-block;">
                <span id="target-add-mentor" class="highlight-anchor"></span>
                <a href="${url(ctxt, 'mentor')}" class="btn btn-primary">Add Mentor</a>
            </span>
        </div>
    </div>
    <hr/>
</%def>


<%def name="productBox(company)">
    %if not company.product_is_setup:
        <div class="box-card shaded"><div class="empty">Product not set up</div></div>
        <div class="mar-top-1">
        %if ctxt.canEdit:
            <a href="${url(ctxt, 'productsetup')}" class="btn btn-primary">Setup Your Product</a>
        %else:
            <h3>Not Setup yet</h3>
        %endif
        </div>
    %else:
        <div class="clearfix"><div class="cut-corner pull-left"><img src="${company.product_picture(request)}"/></div></div>
        <div class="mar-top-half">
            <a href="${url(ctxt, 'product')}" class="overflow"><strong>${company.product_name}</strong></a>
            <small>${html.nn(company.product_description) | html.trunc(90)}</small>
        </div>
        <hr/>
        <div class="number-widget">
            <h6>Pledges</h6>
            <div class="value light">${company.no_pledges}</div>
        </div>
        <hr/>
        %if len(company.pledgees):
            <h6>Customers</h6>
            <div class="picture-pile">
                %for pledge in company.pledgees[:4]:
                    <div class="picture mini">
                        <img src="${pledge.picture}"/>
                    </div>
                %endfor
            </div>
        <hr/>
        %endif
    %endif
</%def>



<%def name="lowerContent()">
    <div class="row mar-top-2" id="project-round-need-dashboard" data-entity-id=${ctxt.round.token}>
        <%self:renderNeedColumns needs="${company.groupedNeeds(3, False)}">
            <div class="col col-lg-12">
                <div class="box-title highlight-target">
                    <div id="target-customise-needs" class="highlight-anchor"></div>
                    Pending Needs
                </div>
            </div>
        </%self:renderNeedColumns>
    </div>
    <%self:renderNeedColumns needs="${company.groupedNeeds(3, True)}">
        <div class="col col-lg-12 mar-top-2"><div class="box-title">
            %if ctxt.round.published:
                Needs
            %else:
                Customized Needs
            %endif
        </div></div>
    </%self:renderNeedColumns>
</%def>


<%def name="renderNeedColumns(needs)">
    %if needs:
        ${caller.body()}
        %for i, col in enumerate(needs):
            <div class="col col-lg-4 need-card-list">
                <div class="js-need-card-list">
                %for need in col:
                    ${self.buildNeed(need, ctxt.round.published)}
                %endfor
                </div>
                %if not i and ctxt.canEdit and not ctxt.round.published:
                    <a href="${url(ctxt, 'addneed')}" class="need-card-inner add-card">
                        <img src="${STATIC_URL}img/addneed.png"/>
                        <h4>Create a new Need</h4>
                    </a>
                %endif
            </div>
        %endfor
    %endif
</%def>

<%def name="buildNeed(need, published)">
    <div class="need-card ${need.status}" data-entity-id="${need.token}">
        %if need.fulfilled:
            <a class="customize success" href="#"><span class="glyphicon glyphicon-ok-sign"></span> Need Fulfilled</a>
        %elif not published  and ctxt.canEdit:
            %if need.customized:
                <a class="customize success" href="${url(ctxt, need.slug)}"><span class="glyphicon glyphicon-ok-sign"></span> Customized</a>
            %else:
                <a class="customize danger" href="${url(ctxt, need.slug, 'edit')}"><span class="glyphicon glyphicon-pencil"></span> Customize Need</a>
            %endif
        %endif
        <div class="need-card-inner">
            <div class="box-header box-header-muted box-card">
                %if not published and ctxt.canEdit:
                    <a class="remove" data-target=".need-card">Ã—</a>
                %endif
                <h5>
                    %if not need.customized and ctxt.canEdit:
                        <a href="${url(ctxt, need.slug, 'edit')}">${need.name}</a>
                    %else:
                        <a href="${url(ctxt, need.slug)}">${need.name}</a>
                    %endif
                </h5>

                <div class="description">
                    ${ html.coalesce(need.customText, need.summary) | html.trunc(300) }
                </div>
            </div>

            %if need.customized:
                <div class="box-content">
                    ${widgets.valuation_sml(need)}
               </div>
               <hr class="boxed"/>
            %endif
            <div class="box-content">
                %for tag in need.tags:
                    <span class="label label-info spaced text-small">${tag}</span>
                %endfor
            </div>
            %if need.experts:
                <hr class="boxed"/>
                <div class="box-content">
                    <div class="experts">
                        <h6>Recomended Experts</h6>
                        <div class="picture-pile">
                        %for expert in need.experts[:4]:
                            <div class="picture small">
                                <img src="${expert.picture}" alt="${expert.name}"/>
                            </div>
                        %endfor
                        </div>
                    </div>
                </div>
            %endif
            %if need.services:
                <hr class="boxed"/>
                <div class="box-content">
                <div class="services">
                    <h6>Recomended Cloud Services</h6>
                    <div class="picture-pile">
                    %for service in need.services[:4]:
                        <div class="picture small">
                            <img src="${service.logo_url}" name="${service.name}"/>
                        </div>
                    %endfor
                    </div>
                </div>
                </div>
            %endif
        </div>
    </div>
</%def>




<%def name="sideBar(currentRound, canEdit)">
    %if currentRound.published:
        ${self.timerBox(currentRound, canEdit)}
    %elif canEdit:
        ${self.workflowBox(currentRound.Workflow, canEdit)}
    %endif
</%def>

<%def name="timerBox(currentRound, canEdit)">
    <div class="company-dashboard">
        <ul class="list-unstyled">
            <li class="progress-step progress-1">
                <h2 class="no-margin">You've got</h2>
                <div class="tachymeter" id="tachymeter">
                    <h1>${currentRound.getExpiryDays(singular = "{}<small>Day Left</small>", plural="{}<small>Days Left</small>")|n}</h1>
                </div>
                <h2>to fulfill your needs.</h2>
            </li>
            <li class="progress-step progress-2">
                <h2 class="no-margin">You successfully fulfilled</h2>
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar" style="width: ${100.0 * currentRound.noFulfilledNeeds / currentRound.noTotalNeeds}%"></div>
                    </div>
                    <h2 class="offset">
                        ${currentRound.noFulfilledNeeds}<small>${pluralize("need", "needs", currentRound.noFulfilledNeeds)}</small>
                    </h2>
                </div>
            </li>
            <li class="progress-step progress-3">
                <h2>Spread the word</h2>
                <a href="#" class="btn btn-primary offset">Spread the word</a>
            </li>
        </ul>
    </div>
</%def>


<%def name="workflowBox(wf, canEdit)">
    <%
        active = wf.getActiveStage()
    %>
    <div class="wtf-box company-dashboard">
        <h2 class="wtf-title">
            Steps
        </h2>
        <div class="wtf-content">
            Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.
        </div>
    </div>
    <ul class="list-unstyled">
        %for i, stage in enumerate(wf.sortedStages):
            <li>
                <a class="workflow-link${' active' if active and active.name == stage.name else ''}${' done' if stage.completed else ''} wtf-${i+1}" href="#target-${stage.slug}">
                    <span class="position">${i+1}</span>${stage.display_name}
                </a>
            </li>
        %endfor
    </ul>

    <div class="mar-top-2 highlight-target">
        <div id="target-publish" class="highlight-anchor"></div>
        <div id="target-sent-for-mentor-aprroval" class="highlight-anchor"></div>
        %if ctxt.canEdit:
            %if wf.canAskForApproval():
                <a href="${url(ctxt, 'askforapproval')}" class="btn btn-primary btn-block btn-large">Get Approval</a>
            %endif
        %elif ctxt.canApprove:
            %if wf.canPublish():
                <a href="${url(ctxt, 'approve')}" class="btn btn-primary btn-block btn-large">Approve Round</a>
            %else:
                <a class="btn btn-primary btn-block btn-large disabled">Approve Round</a>
            %endif
        %endif
    </div>
</%def>


<%def name="extra_head()">
    %if ctxt.round.published:
        <script type="text/javascript" src="${ROOT_STATIC_URL}scripts/dist/raphael-min.js"></script>
    %endif
</%def>
<%def name="post_scripts()">
<script>
    require(["views/company/dashboard", "libs/tachymeter"], function(View, Tacho){
        var view =new View({
            el: $("#project-round-need-dashboard")
        });
        %if ctxt.round.published:
            new Tacho({el: document.getElementById('tachymeter'), fillRatio: ${ctxt.round.getExpiryPercentage()}});
        %endif
    });
</script>
</%def>

